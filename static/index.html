<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VeriCampus Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- Mobile App Meta Tags -->
    <meta name="theme-color" content="#075E54">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <style>
        /* WhatsApp-like Styling */
        body {
            background-color: #e5ddd5;
            /* WhatsApp Doodle Background Pattern */
            background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png");
            background-repeat: repeat;
            background-size: 400px; 
        }
        .chat-bubble-user {
            background-color: #dcf8c6;
            border-radius: 7px 0 7px 7px;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
            max-width: 85%;
            align-self: flex-end;
            position: relative;
        }
        .chat-bubble-ai {
            background-color: #ffffff;
            border-radius: 0 7px 7px 7px;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
            max-width: 85%;
            align-self: flex-start;
            position: relative;
        }
        /* Hide Scrollbar for clean look */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #bbb; border-radius: 2px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden font-sans">

    <!-- HEADER -->
    <div class="bg-[#075E54] text-white p-3 shadow-md flex justify-between items-center z-20">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-[#075E54] font-bold text-xl shadow-sm">V</div>
            <div class="flex flex-col">
                <h1 class="font-bold text-lg leading-tight">VeriCampus</h1>
                <p class="text-[10px] text-green-100 truncate w-40" id="header-status">Tap to Login</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
             <!-- Reload Button -->
             <button onclick="location.reload()" class="text-white opacity-80 hover:opacity-100"><i class="fas fa-sync-alt"></i></button>
        </div>
    </div>

    <!-- LOGIN MODAL (Overlay) -->
    <div id="login-screen" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl overflow-hidden">
            <div class="bg-[#075E54] p-6 text-center relative">
                <div class="absolute top-4 right-4 text-white/20 text-6xl"><i class="fas fa-shield-alt"></i></div>
                <h2 class="text-xl font-bold text-white relative z-10">Student Access</h2>
                <p class="text-green-100 text-xs relative z-10">Enter your School Code to begin</p>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">School ID</label>
                    <input type="text" id="school-id-input" placeholder="e.g. FUTO-2845" 
                           class="w-full mt-1 px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-lg text-gray-900 focus:border-[#075E54] focus:ring-0 outline-none uppercase font-bold text-center tracking-widest text-lg transition-colors">
                </div>
                <button onclick="login()" class="w-full bg-[#128C7E] hover:bg-[#075E54] text-white font-bold py-3.5 rounded-lg transition shadow-lg transform active:scale-95">
                    Start Chatting
                </button>
            </div>
            <div class="bg-gray-50 p-3 text-center border-t border-gray-100">
                <p class="text-[10px] text-gray-400">Protected by VeriCampus Hybrid RAG</p>
            </div>
        </div>
    </div>

    <!-- CHAT AREA -->
    <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-2 flex flex-col pb-20">
        <!-- Encryption Notice -->
        <div class="flex justify-center my-4">
            <span class="bg-[#fff5c4] text-gray-600 text-[10px] px-3 py-1 rounded-lg shadow-sm text-center">
                <i class="fas fa-lock text-[8px] mr-1"></i> Messages are processed securely via Cloud Brain
            </span>
        </div>
        
        <!-- AI Welcome Message -->
        <div class="chat-bubble-ai p-2 px-3">
            <p class="text-sm text-gray-800 leading-snug">
                üëã Hello! I am ready. Please enter your School ID to connect to your campus database.
            </p>
            <div class="text-[10px] text-gray-400 text-right mt-1 flex justify-end items-center gap-1">
                <span>Now</span>
            </div>
        </div>
    </div>

    <!-- INPUT AREA -->
    <div class="bg-[#f0f0f0] p-2 px-3 flex items-center gap-2 fixed bottom-0 w-full z-20 safe-area-pb">
        <div class="flex-1 bg-white rounded-full flex items-center px-4 py-2 shadow-sm border border-gray-200">
            <input type="text" id="user-input" 
                   class="flex-1 bg-transparent border-0 text-sm focus:outline-none text-gray-700 placeholder-gray-400" 
                   placeholder="Type a message..." 
                   autocomplete="off"
                   onkeypress="handleEnter(event)">
        </div>
        <button onclick="sendMessage()" id="send-btn" class="bg-[#128C7E] text-white w-10 h-10 rounded-full flex items-center justify-center shadow-md transition transform active:scale-90 disabled:opacity-50 disabled:cursor-not-allowed">
            <i class="fas fa-paper-plane text-sm pl-0.5"></i>
        </button>
    </div>

    <script>
        let currentSchoolID = "";

        function handleEnter(e) {
            if (e.key === 'Enter') sendMessage();
        }

        function login() {
            const input = document.getElementById('school-id-input');
            const val = input.value.trim();
            
            if(!val) {
                // Shake animation for error
                input.parentElement.classList.add('animate-bounce');
                setTimeout(() => input.parentElement.classList.remove('animate-bounce'), 500);
                return;
            }
            
            currentSchoolID = val.toUpperCase();
            
            // Hide login screen
            document.getElementById('login-screen').style.display = 'none';
            
            // Update Header
            document.getElementById('header-status').innerText = currentSchoolID;
            
            // Add system message to chat
            addSystemMessage(`Connected to ${currentSchoolID}`);
        }
        
        function getTime() {
            const now = new Date();
            return now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function addSystemMessage(text) {
            const chatBox = document.getElementById('chat-box');
            chatBox.innerHTML += `
                <div class="flex justify-center my-2">
                    <span class="bg-[#e1f3fb] text-gray-600 text-[10px] px-2 py-1 rounded shadow-sm uppercase font-bold tracking-wide">
                        ${text}
                    </span>
                </div>`;
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const message = input.value.trim();
            
            if (!message) return;
            
            if (!currentSchoolID) {
                // Force login if they bypassed it
                document.getElementById('login-screen').style.display = 'flex';
                return;
            }
            
            const chatBox = document.getElementById('chat-box');
            
            // 1. Add User Bubble
            chatBox.innerHTML += `
                <div class="chat-bubble-user p-2 px-3 mb-2">
                    <p class="text-sm text-gray-800 leading-snug">${message}</p>
                    <div class="text-[10px] text-green-800/60 text-right mt-1 flex justify-end items-center gap-1">
                        <span>${getTime()}</span>
                        <i class="fas fa-check text-green-600"></i>
                    </div>
                </div>`;
            
            input.value = '';
            chatBox.scrollTop = chatBox.scrollHeight;

            // 2. Add Loading Bubble
            const loadingId = "loading-" + Date.now();
            chatBox.innerHTML += `
                <div id="${loadingId}" class="chat-bubble-ai p-3 px-4 mb-2 animate-pulse">
                    <div class="flex gap-1">
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    </div>
                </div>`;
            chatBox.scrollTop = chatBox.scrollHeight;

            // Disable inputs
            input.disabled = true;
            sendBtn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('question', message);
                formData.append('school_id', currentSchoolID);
                
                const response = await fetch(`/chat`, { method: 'POST', body: formData });
                const data = await response.json();
                
                // Remove loading
                document.getElementById(loadingId).remove();
                
                // 3. Add AI Response Bubble
                const formattedAnswer = data.answer.replace(/\n/g, '<br>');
                chatBox.innerHTML += `
                    <div class="chat-bubble-ai p-2 px-3 mb-2">
                        <p class="text-sm text-gray-800 leading-relaxed">${formattedAnswer}</p>
                        <div class="text-[10px] text-gray-400 text-right mt-1">
                            <span>${getTime()}</span>
                        </div>
                    </div>`;
                
            } catch (err) {
                document.getElementById(loadingId).remove();
                addSystemMessage("‚ö†Ô∏è Connection Error. Server might be sleeping.");
            } finally {
                input.disabled = false;
                sendBtn.disabled = false;
                input.focus();
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }
    </script>
</body>
</html>